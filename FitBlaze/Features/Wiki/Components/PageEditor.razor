@using FitBlaze.Features.Wiki.Models
@using FitBlaze.Features.Wiki.Services
@using Markdig
@inject PageService PageService
@inject NavigationManager Navigation

<div class="page-editor">
    @if (isLoading)
    {
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    }
    else
    {
        <div class="editor-container">
            <div class="editor-form">
                <h2>@(isEditing ? "Edit Page" : "Create New Page")</h2>

                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" 
                           @bind="form.Title" placeholder="Page title" />
                </div>

                <div class="mb-3">
                    <label for="slug" class="form-label">Slug</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="slug" 
                               @bind="form.Slug" placeholder="url-friendly-slug" />
                        <button class="btn btn-outline-secondary" type="button" @onclick="GenerateSlug">
                            Auto-generate
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="parent" class="form-label">Parent Page</label>
                    <select class="form-select" id="parent" @bind="form.ParentIdString">
                        <option value="">-- No parent (root page) --</option>
                        @if (availableParents != null)
                        {
                            @foreach (var parent in availableParents)
                            {
                                <option value="@parent.Id">@parent.Title</option>
                            }
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label for="tags" class="form-label">Tags (comma-separated)</label>
                    <input type="text" class="form-control" id="tags" 
                           @bind="form.Tags" placeholder="tag1, tag2, tag3" />
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="preview" @bind="showPreview" />
                    <label class="form-check-label" for="preview">
                        Show preview
                    </label>
                </div>

                <div class="mb-3">
                    <label for="content" class="form-label">Content (Markdown)</label>
                    <textarea class="form-control" id="content" rows="15" 
                              @bind="form.Content" placeholder="Enter markdown content..."></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" @onclick="SavePage">
                        <span class="oi oi-check"></span> Save
                    </button>
                    <button class="btn btn-secondary" @onclick="CancelEdit">
                        <span class="oi oi-x"></span> Cancel
                    </button>
                </div>
            </div>

            @if (showPreview)
            {
                <div class="preview-pane">
                    <h3>Preview</h3>
                    <div class="preview-content">
                        @((MarkupString)Markdown.ToHtml(form.Content ?? ""))
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public string? Slug { get; set; }

    private bool isLoading = true;
    private bool isEditing = false;
    private bool showPreview = false;
    private WikiPage? currentPage;
    private List<WikiPage>? availableParents;

    private PageForm form = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadParents();

        if (!string.IsNullOrEmpty(Slug))
        {
            await LoadPageForEdit();
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadPageForEdit()
    {
        isLoading = true;
        try
        {
            currentPage = await PageService.GetPageBySlugAsync(Slug!);
            if (currentPage != null)
            {
                isEditing = true;
                form = new PageForm
                {
                    Title = currentPage.Title,
                    Slug = currentPage.Slug,
                    Content = currentPage.Content,
                    Tags = currentPage.Tags,
                    ParentIdString = currentPage.ParentId?.ToString() ?? ""
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading page: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadParents()
    {
        try
        {
            var allPages = await PageService.GetAllPagesAsync(1, 500);
            availableParents = allPages
                .Where(p => p.Id != currentPage?.Id)
                .OrderBy(p => p.Title)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading parents: {ex.Message}");
        }
    }

    private async Task GenerateSlug()
    {
        if (!string.IsNullOrEmpty(form.Title))
        {
            try
            {
                form.Slug = await PageService.GenerateSlugAsync(form.Title);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error generating slug: {ex.Message}");
            }
        }
    }

    private async Task SavePage()
    {
        if (string.IsNullOrEmpty(form.Title))
        {
            return;
        }

        try
        {
            if (isEditing && currentPage != null)
            {
                var parentId = string.IsNullOrEmpty(form.ParentIdString) ? (Guid?)null : Guid.Parse(form.ParentIdString);
                await PageService.UpdatePageAsync(currentPage.Id, form.Title, form.Content ?? "", form.Slug, parentId, form.Tags);
                Navigation.NavigateTo($"/wiki/{form.Slug}");
            }
            else
            {
                var parentId = string.IsNullOrEmpty(form.ParentIdString) ? (Guid?)null : Guid.Parse(form.ParentIdString);
                var newPage = await PageService.CreatePageAsync(form.Title, form.Content ?? "", parentId, form.Slug, form.Tags);
                Navigation.NavigateTo($"/wiki/{newPage.Slug}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving page: {ex.Message}");
        }
    }

    private void CancelEdit()
    {
        if (isEditing && currentPage != null)
        {
            Navigation.NavigateTo($"/wiki/{currentPage.Slug}");
        }
        else
        {
            Navigation.NavigateTo("/wiki");
        }
    }

    private class PageForm
    {
        public string Title { get; set; } = "";
        public string Slug { get; set; } = "";
        public string Content { get; set; } = "";
        public string Tags { get; set; } = "";
        public string ParentIdString { get; set; } = "";
    }
}

<style>
    .page-editor {
        padding: 1rem 0;
    }

    .editor-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .editor-form {
        display: flex;
        flex-direction: column;
    }

    .editor-form h2 {
        margin-bottom: 1.5rem;
    }

    .preview-pane {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        background-color: #f8f9fa;
        max-height: 600px;
        overflow-y: auto;
    }

    .preview-pane h3 {
        margin-top: 0;
    }

    .preview-content {
        font-size: 0.95rem;
    }

    .button-group {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .button-group button {
        flex: 0;
    }
</style>
